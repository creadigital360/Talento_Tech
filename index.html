document.addEventListener('DOMContentLoaded', () => {
    // Definiciones de elementos del DOM
    const overlay = document.getElementById('cd360-overlay');
    const toast = document.getElementById('cd360-toast');
    const linkContacto = document.getElementById('link-contacto');
    const btnClose = document.querySelector('.cd360-close');
    const btnCancelar = document.getElementById('cd360-cancelar');
    const form = document.getElementById('cd360-contact-form');
    const btnEnviar = document.getElementById('cd360-enviar');

    // Funciones de utilidad
    function openModal(){
        overlay.style.display='flex';
        overlay.setAttribute('aria-hidden','false');
        setTimeout(()=> document.getElementById('cd360-nombre')?.focus(), 80);
    }
    function closeModal(){
        overlay.style.display='none';
        overlay.setAttribute('aria-hidden','true');
    }
    function showToast(msg='¡Mensaje enviado! Te contactaremos pronto.', ok=true){
        toast.textContent = msg;
        toast.classList.toggle('err', !ok);
        toast.classList.add('cd360-toast--show');
        setTimeout(()=> toast.classList.remove('cd360-toast--show'), 3800);
    }
    function setLoading(is){
        if(is){
            btnEnviar.classList.add('is-loading');
            btnEnviar.innerHTML = '<span class="spinner"></span>Enviando…';
            btnEnviar.disabled = true;
        }else{
            btnEnviar.classList.remove('is-loading');
            btnEnviar.textContent = 'Enviar mensaje';
            btnEnviar.disabled = false;
        }
    }

    // Event Listeners para el modal
    linkContacto?.addEventListener('click', e => { e.preventDefault(); openModal(); });
    btnClose?.addEventListener('click', closeModal);
    btnCancelar?.addEventListener('click', closeModal);
    overlay.addEventListener('click', e => { if(e.target === overlay) closeModal(); });
    document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });

    // Lógica de Envío del Formulario (CORREGIDA)
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // 1. Validación nativa del formulario
        if(!form.checkValidity()){ 
            form.reportValidity(); 
            return; 
        }

        // 2. Recoger datos con FormData (compatible con servicios externos)
        const formData = new FormData(form);
        
        // 3. Revisar Honeypot (campo '_gotcha')
        // Si el campo oculto tiene algo, es un bot. Simular éxito y terminar.
        const honeypotValue = formData.get('_gotcha');

        if (honeypotValue && honeypotValue.length > 0) {
            setLoading(false);
            showToast('¡Gracias! Tu mensaje fue enviado con éxito.', true);
            form.reset();
            closeModal();
            return; 
        }
        
        // 4. Configurar Timeout y estado de carga
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 15000);

        setLoading(true);
        try{
            // 5. Enviar usando fetch a la URL definida en el atributo 'action' del HTML
            const res = await fetch(form.action, {
                method:'POST',
                // Enviamos el objeto FormData. NO se necesitan headers JSON
                body: formData, 
                signal: controller.signal
            });

            clearTimeout(t);

            // 6. Manejo de la Respuesta
            if(!res.ok){
                let errorData;
                const ct = res.headers.get('content-type') || '';
                if (ct.includes('application/json')) {
                    errorData = await res.json();
                    throw new Error(errorData?.error || 'Error desconocido del servicio.');
                }
                throw new Error('El servicio de formularios externo falló.');
            }

            // Éxito
            setLoading(false);
            showToast('¡Gracias! Tu mensaje fue enviado con éxito.', true);
            form.reset();
            closeModal();
        }catch(err){
            clearTimeout(t);
            console.error('Error en fetch:', err);
            setLoading(false);

            // Manejo de errores
            if (err.name === 'AbortError') {
                showToast('El servidor tardó demasiado en responder.', false);
            } else if (String(err).includes('Failed to fetch') || err instanceof TypeError) {
                showToast('No se pudo conectar con el servicio externo. Verifica tu URL de acción.', false);
            } else {
                showToast(err.message || 'Error al enviar. Inténtalo más tarde.', false);
            }
        }
    });
});
