document.addEventListener('DOMContentLoaded', () => {
    // Definiciones de elementos del DOM
    const overlay = document.getElementById('cd360-overlay');
    const toast = document.getElementById('cd360-toast');
    const linkContacto = document.getElementById('link-contacto');
    const btnClose = document.querySelector('.cd360-close');
    const btnCancelar = document.getElementById('cd360-cancelar');
    const form = document.getElementById('cd360-contact-form');
    const btnEnviar = document.getElementById('cd360-enviar');

    // Funciones de utilidad
    function openModal(){
        overlay.style.display='flex';
        overlay.setAttribute('aria-hidden','false');
        setTimeout(()=> document.getElementById('cd360-nombre')?.focus(), 80);
    }
    function closeModal(){
        overlay.style.display='none';
        overlay.setAttribute('aria-hidden','true');
    }
    function showToast(msg='¡Mensaje enviado! Te contactaremos pronto.', ok=true){
        toast.textContent = msg;
        toast.classList.toggle('err', !ok);
        toast.classList.add('cd360-toast--show');
        setTimeout(()=> toast.classList.remove('cd360-toast--show'), 3800);
    }
    function setLoading(is){
        if(is){
            btnEnviar.classList.add('is-loading');
            btnEnviar.innerHTML = '<span class="spinner"></span>Enviando…';
            btnEnviar.disabled = true;
        }else{
            btnEnviar.classList.remove('is-loading');
            btnEnviar.textContent = 'Enviar mensaje';
            btnEnviar.disabled = false;
        }
    }

    // Event Listeners para el modal
    linkContacto?.addEventListener('click', e => { e.preventDefault(); openModal(); });
    btnClose?.addEventListener('click', closeModal);
    btnCancelar?.addEventListener('click', closeModal);
    overlay.addEventListener('click', e => { if(e.target === overlay) closeModal(); });
    document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });

    // ------------------------------------------
    // Lógica de Envío del Formulario (CORRECCIÓN FINAL Y ROBUSTA)
    // ------------------------------------------
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if(!form.checkValidity()){ 
            form.reportValidity(); 
            return; 
        }

        const formData = new FormData(form);
        
        // Revisar Honeypot (campo '_gotcha')
        const honeypotValue = formData.get('_gotcha');

        if (honeypotValue && honeypotValue.length > 0) {
            setLoading(false);
            showToast('¡Gracias! Tu mensaje fue enviado con éxito.', true);
            form.reset();
            closeModal();
            return; 
        }
        
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 15000);

        setLoading(true);
        try{
            // Enviamos FormData al action del formulario (URL de Formspree)
            const res = await fetch(form.action, {
                method:'POST',
                body: formData, 
                signal: controller.signal
            });

            clearTimeout(t);

            // CORRECCIÓN CRÍTICA: Solo verificamos el estado HTTP.
            // Formspree devuelve 200/302 para éxito. Si falla, es un error HTTP 4xx/5xx.
            if(!res.ok){
                // Si la respuesta no es OK, siempre es un error, sin importar el formato.
                // Intentar obtener el error, pero manejar la excepción si no es JSON.
                let errorMsg = `Error al enviar. Código: ${res.status}.`;

                try {
                    // Intenta leer el cuerpo para obtener un error detallado de Formspree
                    const errorData = await res.json();
                    errorMsg = errorData?.error || errorMsg;
                } catch (e) {
                    // Ignoramos el error de formato JSON si la respuesta no fue OK,
                    // y usamos el mensaje de error genérico.
                }

                throw new Error(errorMsg);
            }

            // Éxito (Formspree devolvió un código 2xx/3xx)
            setLoading(false);
            showToast('¡Gracias! Tu mensaje fue enviado con éxito.', true);
            form.reset();
            closeModal();
        }catch(err){
            clearTimeout(t);
            console.error('Error en fetch:', err);
            setLoading(false);

            // Manejo de errores
            if (err.name === 'AbortError') {
                showToast('El servidor tardó demasiado en responder.', false);
            } else if (String(err).includes('Failed to fetch') || err instanceof TypeError) {
                showToast('No se pudo conectar con el servicio. Revisa tu URL de Formspree.', false);
            } else {
                // Muestra el mensaje de error del servidor o el genérico
                showToast(err.message || 'Error al enviar. Inténtalo más tarde.', false);
            }
        }
    });
});
