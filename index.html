document.addEventListener('DOMContentLoaded', () => {
    // Definiciones de elementos del DOM
    const overlay = document.getElementById('cd360-overlay');
    const toast = document.getElementById('cd360-toast');
    const linkContacto = document.getElementById('link-contacto');
    const btnClose = document.querySelector('.cd360-close');
    const btnCancelar = document.getElementById('cd360-cancelar');
    const form = document.getElementById('cd360-contact-form');
    const btnEnviar = document.getElementById('cd360-enviar');

    // Funciones de utilidad
    function openModal(){
        overlay.style.display='flex';
        overlay.setAttribute('aria-hidden','false');
        setTimeout(()=> document.getElementById('cd360-nombre')?.focus(), 80);
    }
    function closeModal(){
        overlay.style.display='none';
        overlay.setAttribute('aria-hidden','true');
    }
    function showToast(msg='¡Mensaje enviado! Te contactaremos pronto.', ok=true){
        toast.textContent = msg;
        toast.classList.toggle('err', !ok);
        toast.classList.add('cd360-toast--show');
        setTimeout(()=> toast.classList.remove('cd360-toast--show'), 3800);
    }
    function setLoading(is){
        if(is){
            btnEnviar.classList.add('is-loading');
            btnEnviar.innerHTML = '<span class="spinner"></span>Enviando…';
            btnEnviar.disabled = true;
        }else{
            btnEnviar.classList.remove('is-loading');
            btnEnviar.textContent = 'Enviar mensaje';
            btnEnviar.disabled = false;
        }
    }

    // Event Listeners para el modal
    linkContacto?.addEventListener('click', e => { e.preventDefault(); openModal(); });
    btnClose?.addEventListener('click', closeModal);
    btnCancelar?.addEventListener('click', closeModal);
    overlay.addEventListener('click', e => { if(e.target === overlay) closeModal(); });
    document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });

    // ------------------------------------------
    // Lógica de Envío del Formulario (CORRECCIÓN FINAL)
    // ------------------------------------------
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if(!form.checkValidity()){ 
            form.reportValidity(); 
            return; 
        }

        const formData = new FormData(form);
        
        // Revisar Honeypot (campo '_gotcha')
        const honeypotValue = formData.get('_gotcha');

        if (honeypotValue && honeypotValue.length > 0) {
            // Es un bot. Simular éxito y terminar.
            setLoading(false);
            showToast('¡Gracias! Tu mensaje fue enviado con éxito.', true);
            form.reset();
            closeModal();
            return; 
        }
        
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 15000);

        setLoading(true);
        try{
            // Enviamos FormData al action del formulario (URL de Formspree)
            const res = await fetch(form.action, {
                method:'POST',
                body: formData, 
                signal: controller.signal
            });

            clearTimeout(t);

            // Si la respuesta no es OK (código 2xx), lanzamos un error.
            // Esto captura errores 400, 403, 500, etc., que Formspree devuelve
            // Y ELIMINAMOS la lectura compleja de JSON/Texto que causaba el error de formato inesperado.
            if(!res.ok){
                // Intentamos leer el JSON de error de Formspree si está disponible
                try {
                    const errorData = await res.json();
                    throw new Error(errorData?.error || 'Error al procesar la solicitud. Verifica tu configuración en Formspree.');
                } catch (jsonError) {
                    // Si falla la lectura del JSON, el error se maneja como genérico.
                    throw new Error('El servicio de formularios externo falló con código de error ' + res.status);
                }
            }

            // Éxito (Formspree devolvió un código 2xx)
            setLoading(false);
            showToast('¡Gracias! Tu mensaje fue enviado con éxito.', true);
            form.reset();
            closeModal();
        }catch(err){
            clearTimeout(t);
            console.error('Error en fetch:', err);
            setLoading(false);

            // Manejo de errores
            if (err.name === 'AbortError') {
                showToast('El servidor tardó demasiado en responder.', false);
            } else if (String(err).includes('Failed to fetch') || err instanceof TypeError) {
                showToast('No se pudo conectar con el servicio externo. Revisa tu URL de Formspree.', false);
            } else {
                showToast(err.message || 'Error al enviar. Inténtalo más tarde.', false);
            }
        }
    });
});
